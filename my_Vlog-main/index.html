<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>我的博客</title>
  <meta name="description" content="基于 Firebase 的极简博客">
  <meta property="og:type" content="website">
  <meta property="og:site_name" content="我的博客">
  <link rel="stylesheet" href="css/main.css">
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true">
          <img id="site-avatar" alt="站点头像" loading="lazy">
        </div>
        <div>
          <h1 class="title" id="site-title">我的博客</h1>
          <div class="bio" id="site-bio">记录学习与生活</div>
        </div>
      </div>
      <nav>
        <a href="admin-profile.html">作者资料</a>
        <a class="btn" href="admin-editor.html">＋ 创作</a>
      </nav>
    </header>

    <main id="app" class="card">
      <div class="loading">
        <div class="spinner"></div>
        正在加载...
      </div>
    </main>

    <footer>
      <span id="site-footer">© <span id="year"></span> Powered by Firebase & GitHub Pages</span>
    </footer>
  </div>

  <a class="fab" title="新建文章" href="admin-editor.html" aria-label="新建文章">＋</a>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  
  <!-- 应用模块 -->
  <script type="module">
    import { ADMIN_UID } from './js/config.js';
    import './js/firebase.js';
    import { getProfile } from './js/api.profile.js';
    import { listPublished, getPostByIdOrSlug } from './js/api.posts.js';
    import { 
      $, 
      escapeHtml, 
      stripTags, 
      formatDate, 
      calculateReadingTime, 
      generateExcerpt,
      renderTags,
      applySiteBg,
      HashRouter,
      showLoading,
      showError,
      showEmpty,
      setPageTitle,
      setPageMeta,
      lazyLoadImages
    } from './js/render.js';

    // 初始化年份
    $('#year').textContent = new Date().getFullYear();

    // 路由实例
    const router = new HashRouter();

    // 加载站点资料
    async function loadSiteProfile() {
      try {
        const profile = await getProfile(ADMIN_UID);
        if (profile) {
          const siteName = profile.displayName ? `${profile.displayName}的博客` : '我的博客';
          $('#site-title').textContent = siteName;
          $('#site-bio').textContent = profile.bio || '记录学习与生活';
          
          if (profile.photoURL) {
            $('#site-avatar').src = profile.photoURL;
          }
          
          if (profile.siteBgUrl) {
            applySiteBg(profile.siteBgUrl);
          }

          // 更新页面标题
          setPageTitle('', siteName);
          
          // 设置页面元数据
          setPageMeta({
            title: siteName,
            description: profile.bio || '记录学习与生活',
            image: profile.photoURL,
            url: window.location.href
          });
        }
      } catch (error) {
        console.warn('加载站点资料失败:', error);
      }
    }

    // 渲染文章列表
    async function renderPostList() {
      const app = $('#app');
      showLoading(app, '加载文章中...');
      
      try {
        const posts = await listPublished({ limit: 20 });
        
        if (posts.length === 0) {
          showEmpty(app, '还没有发布的文章', '期待第一篇精彩内容');
          return;
        }

        app.innerHTML = `
          <section>
            <h2 style="margin: 0 0 16px 0; font-size: 24px;">最新文章</h2>
            <div class="post-list">
              ${posts.map(post => renderPostCard(post)).join('')}
            </div>
          </section>
        `;

        // 懒加载图片
        lazyLoadImages(app);
        
        // 设置页面标题
        setPageTitle('');
        
      } catch (error) {
        console.error('加载文章列表失败:', error);
        
        if (error.message.includes('requires an index') || error.message.includes('FAILED_PRECONDITION')) {
          showError(app, '需要创建 Firestore 索引：posts 集合的 status(升序) + createdAt(降序)');
        } else {
          showError(app, error.message || '加载文章失败', true, () => renderPostList());
        }
      }
    }

    // 渲染文章卡片
    function renderPostCard(post) {
      const excerpt = generateExcerpt(post.contentHtml);
      const tags = renderTags(post.tags || []);
      const readingTime = calculateReadingTime(post.contentHtml);
      const formattedDate = formatDate(post.createdAt);
      
      return `
        <article class="post-card card">
          ${post.coverUrl ? `
            <div style="margin: -18px -18px 12px -18px; border-radius: 16px 16px 0 0; overflow: hidden;">
              <img src="${escapeHtml(post.coverUrl)}" 
                   alt="${escapeHtml(post.title)}" 
                   style="width: 100%; height: 200px; object-fit: cover;"
                   loading="lazy">
            </div>
          ` : ''}
          <h3 class="post-title">
            <a href="#/post/${post.slug || post.id}">${escapeHtml(post.title || '(无标题)')}</a>
          </h3>
          <div class="meta">
            <span>${formattedDate}</span>
            <span>·</span>
            <span>${readingTime}</span>
            ${tags ? `<span>·</span>${tags}` : ''}
          </div>
          ${excerpt ? `<div class="preview">${escapeHtml(excerpt)}</div>` : ''}
        </article>
      `;
    }

    // 渲染文章详情
    async function renderPostDetail(key) {
      const app = $('#app');
      showLoading(app, '加载文章中...');
      
      try {
        const post = await getPostByIdOrSlug(key);
        
        if (!post || post.status !== 'published') {
          app.innerHTML = `
            <div class="empty-state">
              <h3>文章未找到</h3>
              <p>该文章可能已被删除或尚未发布</p>
              <a class="back" href="#/">← 返回列表</a>
            </div>
          `;
          return;
        }

        const tags = renderTags(post.tags || []);
        const readingTime = calculateReadingTime(post.contentHtml);
        const formattedDate = formatDate(post.createdAt);
        
        app.innerHTML = `
          <article>
            <a class="back" href="#/">← 返回列表</a>
            
            ${post.coverUrl ? `
              <div style="margin: 16px 0; border-radius: 16px; overflow: hidden;">
                <img src="${escapeHtml(post.coverUrl)}" 
                     alt="${escapeHtml(post.title)}" 
                     style="width: 100%; height: 300px; object-fit: cover;"
                     loading="lazy">
              </div>
            ` : ''}
            
            <header style="margin-bottom: 24px;">
              <h1 style="margin: 0 0 12px 0; font-size: 32px; line-height: 1.2;">
                ${escapeHtml(post.title || '(无标题)')}
              </h1>
              <div class="meta" style="font-size: 14px;">
                <span>${formattedDate}</span>
                <span>·</span>
                <span>${readingTime}</span>
                ${tags ? `<span>·</span>${tags}` : ''}
              </div>
            </header>
            
            <div class="card">
              <div class="content">${sanitizeHtml(post.contentHtml || '')}</div>
            </div>
          </article>
        `;

        // 懒加载图片
        lazyLoadImages(app);
        
        // 设置页面标题和元数据
        setPageTitle(post.title);
        setPageMeta({
          title: post.title,
          description: generateExcerpt(post.contentHtml, 160),
          image: post.coverUrl,
          url: window.location.href
        });
        
      } catch (error) {
        console.error('加载文章详情失败:', error);
        showError(app, error.message || '加载文章失败', true, () => renderPostDetail(key));
      }
    }

    // 基本 HTML 消毒
    function sanitizeHtml(html) {
      if (!html) return '';
      
      const allowedTags = ['p', 'br', 'strong', 'em', 'u', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6', 
                          'ul', 'ol', 'li', 'blockquote', 'pre', 'code', 'img', 'a'];
      const allowedAttrs = {
        'img': ['src', 'alt', 'title', 'width', 'height'],
        'a': ['href', 'title', 'target', 'rel']
      };
      
      const div = document.createElement('div');
      div.innerHTML = html;
      
      // 移除不允许的标签和属性
      const walker = document.createTreeWalker(
        div,
        NodeFilter.SHOW_ELEMENT,
        null,
        false
      );
      
      const nodesToRemove = [];
      let node;
      
      while (node = walker.nextNode()) {
        const tagName = node.tagName.toLowerCase();
        
        if (!allowedTags.includes(tagName)) {
          nodesToRemove.push(node);
          continue;
        }
        
        // 清理属性
        const attrs = Array.from(node.attributes);
        attrs.forEach(attr => {
          const attrName = attr.name.toLowerCase();
          const allowed = allowedAttrs[tagName] || [];
          
          if (!allowed.includes(attrName)) {
            node.removeAttribute(attr.name);
          }
        });
        
        // 为外链添加安全属性
        if (tagName === 'a' && node.getAttribute('href')) {
          const href = node.getAttribute('href');
          if (href.startsWith('http') && !href.includes(window.location.hostname)) {
            node.setAttribute('target', '_blank');
            node.setAttribute('rel', 'noopener noreferrer');
          }
        }
        
        // 为图片添加懒加载
        if (tagName === 'img') {
          node.setAttribute('loading', 'lazy');
        }
      }
      
      // 移除不允许的节点
      nodesToRemove.forEach(node => {
        if (node.parentNode) {
          node.parentNode.removeChild(node);
        }
      });
      
      return div.innerHTML;
    }

    // 设置路由
    router.addRoute('/', renderPostList);
    router.addRoute('/post/:key', (params) => renderPostDetail(params.key));

    // 初始化应用
    async function initApp() {
      await loadSiteProfile();
    }

    // 启动应用
    initApp();
  </script>
</body>
</html>
