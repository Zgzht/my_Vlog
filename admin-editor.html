<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>创作发布 · Editor</title>
  <style>
    :root{--bg:#0b0b12;--fg:#e9e9ee;--muted:#a3a3b2;--glass:rgba(255,255,255,.06);--r:16px;--brand:#7aa2ff;--accent:#b892ff}
    *{box-sizing:border-box}
    body{margin:0;color:var(--fg);font:15px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      background:radial-gradient(1100px 600px at 90% -10%, rgba(186,146,255,.15), transparent 40%),
                 radial-gradient(1200px 700px at -10% 10%, rgba(122,162,255,.15), transparent 35%), #0b0b12;min-height:100vh}
    .wrap{max-width:980px;margin:0 auto;padding:28px}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
    .nav a{color:#cfd8ff;margin-left:14px;text-decoration:none} .nav a:hover{text-decoration:underline}
    .card{backdrop-filter:blur(10px);background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      border:1px solid var(--glass);border-radius:var(--r);padding:18px;margin-bottom:16px;box-shadow:0 10px 24px rgba(0,0,0,.3)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    input,textarea,button{width:100%;padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,.15);background:#0f0f17;color:var(--fg)}
    .muted{color:var(--muted)}
    .list{display:grid;gap:10px} .item{display:flex;align-items:center;justify-content:space-between;padding:10px;border:1px dashed rgba(255,255,255,.15);border-radius:12px}
    .right{display:flex;gap:8px}
    .ok{background:#113116;border-color:#245a2c} .warn{background:#3a2a11;border-color:#6c4f1e} .err{background:#3a1411;border-color:#6c241e}
    .hidden{display:none}
    .fab{position:fixed;right:22px;bottom:22px;width:56px;height:56px;border-radius:50%;background:linear-gradient(135deg,var(--brand),var(--accent));
         display:flex;align-items:center;justify-content:center;color:#0b0b12;font-size:28px;font-weight:800;box-shadow:0 14px 28px rgba(109,150,255,.35)}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h2 style="margin:0">创作发布</h2>
      <div class="nav">
        <a href="index.html">首页</a>
        <a href="admin-profile.html">作者资料</a>
      </div>
    </header>

    <section id="auth" class="card">
      <div class="muted">只有白名单账号可以写作/发布。</div>
      <div style="margin-top:8px">
        <button id="btnGitHub">GitHub 登录</button>
        <button id="btnEmail">邮箱登录</button>
        <button id="btnLogout" class="hidden">退出</button>
        <span id="who" class="muted" style="margin-left:8px"></span>
      </div>
    </section>

    <section id="editor" class="card hidden">
      <h3 style="margin-top:0">新建文章</h3>
      <div class="row">
        <div><label>标题</label><input id="title" placeholder="文章标题"></div>
        <div><label>标签（逗号分隔）</label><input id="tags" placeholder="技术, 随笔"></div>
      </div>
      <label>正文（支持 HTML；下方“上传图片并插入”）</label>
      <textarea id="content" rows="10" placeholder="<p>写点什么...</p>"></textarea>
      <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
        <input type="file" id="imgFile" accept="image/*" style="max-width:300px">
        <button id="btnUploadImg">上传图片并插入</button>
        <span id="imgMsg" class="muted"></span>
      </div>
      <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
        <button id="btnDraft" class="ok">保存草稿</button>
        <button id="btnPublish" class="ok">直接发布</button>
        <button id="btnClear" class="warn">清空</button>
        <span id="editMsg" class="muted"></span>
      </div>
    </section>

    <section id="mine" class="card hidden">
      <h3 style="margin-top:0">我的文章</h3>
      <div id="list" class="list"></div>
    </section>
  </div>

  <button class="fab" id="openCreate" title="新建文章">＋</button>

  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script>
  // Firebase（你的）
  const firebaseConfig = {
    apiKey: "AIzaSyBR1V5u3zvZIQ-_7jNl8WfdzEmHsuB8vqo",
    authDomain: "project-9037683069333256481.firebaseapp.com",
    projectId: "project-9037683069333256481",
    appId: "1:256096740039:web:875a84e72fb0858354d4e2"
  };
  const ADMIN_UIDS = ["SjLJvvCJciUyhwWR6vaJnqQXUpx2"];

  // Cloudinary（把 YOUR_CLOUD_NAME 改成你的 Cloud name；预设名用 blog_unsigned）
  const CLOUDINARY = { cloudName: "blog_unsigned", unsignedPreset: "blog_unsigned" };

  firebase.initializeApp(firebaseConfig);
  const auth=firebase.auth(); const db=firebase.firestore();
  const $=(s,r=document)=>r.querySelector(s);

  // 登录
  $('#btnGitHub').onclick=async()=>{ try{ await auth.signInWithPopup(new firebase.auth.GithubAuthProvider()); }catch(e){ alert('GitHub 登录失败：'+e.message);} };
  $('#btnEmail').onclick=async()=>{ const email=prompt('邮箱：'); if(!email) return; const pass=prompt('密码（首次自动注册）：'); if(!pass) return;
    try{ await auth.signInWithEmailAndPassword(email, pass);}catch(e){ if(e.code==="auth/user-not-found"){ await auth.createUserWithEmailAndPassword(email, pass);} else alert('邮箱登录失败：'+e.message);} };
  $('#btnLogout').onclick=()=>auth.signOut();

  auth.onAuthStateChanged(async user=>{
    $('#btnLogout').classList.toggle('hidden', !user);
    $('#btnGitHub').classList.toggle('hidden', !!user);
    $('#btnEmail').classList.toggle('hidden', !!user);
    $('#who').textContent = user? (user.displayName||user.email||user.uid) : '';
    const isAdmin = !!user && ADMIN_UIDS.includes(user.uid);
    $('#editor').classList.toggle('hidden', !isAdmin);
    $('#mine').classList.toggle('hidden', !isAdmin);
    $('#openCreate').classList.toggle('hidden', !isAdmin);
    if(isAdmin) startMine(user.uid);
  });

  $('#openCreate').onclick=()=>{ $('#title').value=''; $('#tags').value=''; $('#content').value=''; document.getElementById('title').focus(); window.scrollTo({top:0,behavior:'smooth'}); };

  $('#btnUploadImg').onclick = async()=>{
    const f=$('#imgFile').files[0]; if(!f) return alert('请选择图片');
    const user=auth.currentUser; if(!user) return alert('请先登录');
    const url = await uploadToCloudinary(f, `uploads/${user.uid}`);
    const ta=$('#content'); ta.value += `\n<p><img src="${url}" alt=""/></p>\n`;
    $('#imgMsg').textContent='已上传并插入链接'; setTimeout(()=>$('#imgMsg').textContent='',1500);
  };

  $('#btnDraft').onclick = ()=>save('draft');
  $('#btnPublish').onclick = ()=>save('published');
  $('#btnClear').onclick = ()=>{ $('#title').value=''; $('#tags').value=''; $('#content').value=''; };

  async function save(status){
    const user=auth.currentUser; if(!user) return;
    const title=$('#title').value.trim(); const content=$('#content').value.trim();
    const tags=$('#tags').value.split(',').map(s=>s.trim()).filter(Boolean);
    if(!title||!content) return alert('标题与正文必填');
    const doc={ title, content, tags, status, authorId:user.uid,
      createdAt:firebase.firestore.FieldValue.serverTimestamp(),
      updatedAt:firebase.firestore.FieldValue.serverTimestamp() };
    await db.collection('posts').add(doc);
    $('#editMsg').textContent = status==='published'? '已发布' : '草稿已保存';
    setTimeout(()=>$('#editMsg').textContent='',1500);
    $('#title').value=''; $('#tags').value=''; $('#content').value='';
  }

  function startMine(uid){
    db.collection('posts').where('authorId','==',uid).orderBy('createdAt','desc').onSnapshot(snap=>{
      const box=$('#list'); box.innerHTML='';
      snap.forEach(doc=>{
        const p=doc.data(); const id=doc.id;
        const row=document.createElement('div'); row.className='item';
        row.innerHTML=`<div><b>${escapeHtml(p.title||'(无标题)')}</b> <span class="muted">· ${p.status||'draft'}</span></div>`;
        const r=document.createElement('div'); r.className='right';
        r.append(
          btn('发布','ok',()=>db.collection('posts').doc(id).set({status:'published',updatedAt:firebase.firestore.FieldValue.serverTimestamp()},{merge:true})),
          btn('撤稿','warn',()=>db.collection('posts').doc(id).set({status:'draft',updatedAt:firebase.firestore.FieldValue.serverTimestamp()},{merge:true})),
          btn('删除','err',()=>confirm('确认删除？')&&db.collection('posts').doc(id).delete())
        );
        row.append(r); box.append(row);
      });
    });
  }
  function btn(text,cls,fn){ const b=document.createElement('button'); b.textContent=text; if(cls) b.classList.add(cls); b.onclick=fn; return b; }
  function escapeHtml(s){return (s||'').replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]))}

  async function uploadToCloudinary(file, folder){
    const form=new FormData(); form.append('file',file); form.append('upload_preset',CLOUDINARY.unsignedPreset); if(folder) form.append('folder',folder);
    const res=await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY.cloudName}/upload`,{method:'POST',body:form});
    const data=await res.json(); if(!res.ok||!data.secure_url) throw new Error(data.error?.message||'上传失败');
    return data.secure_url;
  }
  </script>
</body>
</html>
