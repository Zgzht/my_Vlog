<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>作者资料 · Profile</title>
  <style>
    :root{--bg:#0b0b12;--fg:#e9e9ee;--muted:#a3a3b2;--glass:rgba(255,255,255,.06);--r:16px;--brand:#7aa2ff;--accent:#b892ff}
    *{box-sizing:border-box}
    body{margin:0;color:var(--fg);font:15px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      background:radial-gradient(1100px 600px at 90% -10%, rgba(186,146,255,.15), transparent 40%),
                 radial-gradient(1200px 700px at -10% 10%, rgba(122,162,255,.15), transparent 35%), #0b0b12;min-height:100vh}
    .wrap{max-width:980px;margin:0 auto;padding:28px}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
    .nav a{color:#cfd8ff;margin-left:14px;text-decoration:none} .nav a:hover{text-decoration:underline}
    .card{backdrop-filter:blur(10px);background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      border:1px solid var(--glass);border-radius:var(--r);padding:18px;margin-bottom:16px;box-shadow:0 10px 24px rgba(0,0,0,.3)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    label{display:block;margin-bottom:6px;color:#cfd3ff;font-size:13px}
    input,textarea,button{width:100%;padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,.15);background:#0f0f17;color:var(--fg)}
    .flex{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    img.avatar{width:76px;height:76px;border-radius:50%;object-fit:cover;border:1px solid rgba(255,255,255,.2)}
    .muted{color:var(--muted)} .hidden{display:none}
    .chip{display:inline-block;padding:2px 8px;border-radius:999px;background:rgba(186,146,255,.18);margin-right:6px;font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h2 style="margin:0">作者资料</h2>
      <div class="nav">
        <a href="index.html">首页</a>
        <a href="admin-editor.html">→ 去创作发布</a>
      </div>
    </header>

    <section class="card" id="auth">
      <div class="flex">
        <span id="who" class="muted">未登录</span>
        <button id="btnGitHub">GitHub 登录</button>
        <button id="btnEmail">邮箱登录</button>
        <button id="btnLogout" class="hidden">退出</button>
      </div>
      <div class="muted" style="margin-top:6px">此页任何登录用户都可编辑自己的资料。</div>
    </section>

    <section class="card hidden" id="profile">
      <h3 style="margin-top:0">基本信息</h3>
      <div class="flex" style="margin:8px 0 12px">
        <img id="avatar" class="avatar" alt="avatar" src=""/>
        <input type="file" id="avatarFile" accept="image/*" style="max-width:260px">
        <button id="btnAvatar">上传头像（Cloudinary）</button>
      </div>
      <div class="row">
        <div>
          <label>姓名 / 显示名</label>
          <input id="displayName" placeholder="例如：张三">
        </div>
        <div>
          <label>昵称（可选）</label>
          <input id="nickname" placeholder="例如：阿三">
        </div>
      </div>
      <label>标签（逗号分隔）</label>
      <input id="tags" placeholder="前端, 摄影, 篮球">
      <div id="chips" style="margin-top:6px"></div>
      <label style="margin-top:8px">个人简介</label>
      <textarea id="bio" rows="4" placeholder="一句话介绍或简历摘要"></textarea>
      <div class="flex" style="margin-top:8px">
        <button id="btnSave" style="background:#113116;border-color:#245a2c">保存资料</button>
        <span id="msg" class="muted"></span>
      </div>
    </section>

    <section class="card hidden" id="bgsec">
      <h3 style="margin-top:0">背景图（可选）</h3>
      <div class="row">
        <div>
          <label>站点整体背景（首页等）</label>
          <div class="flex">
            <input type="file" id="siteBgFile" accept="image/*" style="max-width:260px">
            <button id="btnSiteBg">上传并应用</button>
          </div>
          <div class="muted" style="margin-top:6px">字段：<code>siteBgUrl</code>（index.html 会自动读取并应用）</div>
        </div>
        <div>
          <label>作者页背景（当前页）</label>
          <div class="flex">
            <input type="file" id="authorBgFile" accept="image/*" style="max-width:260px">
            <button id="btnAuthorBg">上传并应用</button>
          </div>
          <div class="muted" style="margin-top:6px">字段：<code>authorBgUrl</code>（登录后立即预览）</div>
        </div>
      </div>
    </section>
  </div>

  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script>
  // Firebase（你的）
  const firebaseConfig = {
    apiKey: "AIzaSyBR1V5u3zvZIQ-_7jNl8WfdzEmHsuB8vqo",
    authDomain: "project-9037683069333256481.firebaseapp.com",
    projectId: "project-9037683069333256481",
    appId: "1:256096740039:web:875a84e72fb0858354d4e2"
  };
  const ADMIN_UIDS = ["SjLJvvCJciUyhwWR6vaJnqQXUpx2"];

  // Cloudinary（把 YOUR_CLOUD_NAME 改成你 Dashboard 里的 Cloud name）
  const CLOUDINARY = { cloudName: "blog_unsigned", unsignedPreset: "blog_unsigned" };

  firebase.initializeApp(firebaseConfig);
  const auth=firebase.auth(); const db=firebase.firestore();
  const $=(s,r=document)=>r.querySelector(s);
  const who=$('#who'), box=$('#profile'), bg=$('#bgsec');

  $('#btnGitHub').onclick=async()=>{ try{ await auth.signInWithPopup(new firebase.auth.GithubAuthProvider()); }catch(e){ alert('GitHub 登录失败：'+e.message);} };
  $('#btnEmail').onclick=async()=>{ const email=prompt('邮箱：'); if(!email) return; const pass=prompt('密码（首次自动注册）：'); if(!pass) return;
    try{ await auth.signInWithEmailAndPassword(email, pass);}catch(e){ if(e.code==="auth/user-not-found"){ await auth.createUserWithEmailAndPassword(email, pass);} else alert('邮箱登录失败：'+e.message);} };
  $('#btnLogout').onclick=()=>auth.signOut();

  auth.onAuthStateChanged(async user=>{
    const logged=!!user; who.textContent=logged?(user.displayName||user.email||user.uid):'未登录';
    $('#btnLogout').classList.toggle('hidden',!logged); $('#btnGitHub').classList.toggle('hidden',logged); $('#btnEmail').classList.toggle('hidden',logged);
    if(!logged){ box.classList.add('hidden'); bg.classList.add('hidden'); return; }

    box.classList.remove('hidden'); bg.classList.remove('hidden');
    const ref=db.collection('profiles').doc(user.uid); const s=await ref.get(); const p=s.exists?s.data():{};
    $('#displayName').value=p.displayName||''; $('#nickname').value=p.nickname||''; $('#bio').value=p.bio||''; $('#tags').value=(p.tags||[]).join(', ');
    $('#avatar').src=p.photoURL||user.photoURL||'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="76" height="76"><rect width="100%" height="100%" fill="%230f0f17"/><text x="50%" y="56%" font-size="12" fill="%23a3a3b2" text-anchor="middle">no avatar</text></svg>';
    renderChips(p.tags||[]);
    if(p.authorBgUrl){ document.body.style.background=`linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04)), url('${p.authorBgUrl}') center/cover fixed no-repeat, #0b0b12`; }

    $('#btnSave').onclick=async()=>{
      const doc={ displayName:$('#displayName').value.trim(), nickname:$('#nickname').value.trim(), bio:$('#bio').value.trim(),
        tags:$('#tags').value.split(',').map(s=>s.trim()).filter(Boolean), photoURL:$('#avatar').src };
      await ref.set(doc,{merge:true}); renderChips(doc.tags); tip('已保存');
    };
    $('#btnAvatar').onclick=async()=>{ const f=$('#avatarFile').files[0]; if(!f) return alert('请选择文件');
      const url=await upload(f,`avatars/${user.uid}`); $('#avatar').src=url; await ref.set({photoURL:url},{merge:true}); tip('头像已更新'); };
    $('#btnSiteBg').onclick=async()=>{ const f=$('#siteBgFile').files[0]; if(!f) return alert('请选择图片');
      const url=await upload(f,`backgrounds/${user.uid}`); await ref.set({siteBgUrl:url},{merge:true}); tip('站点背景已更新'); };
    $('#btnAuthorBg').onclick=async()=>{ const f=$('#authorBgFile').files[0]; if(!f) return alert('请选择图片');
      const url=await upload(f,`backgrounds/${user.uid}`); await ref.set({authorBgUrl:url},{merge:true});
      document.body.style.background=`linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04)), url('${url}') center/cover fixed no-repeat, #0b0b12`;
      tip('作者页背景已更新'); };
  });

  function renderChips(tags){ $('#chips').innerHTML=(tags||[]).map(t=>`<span class="chip">${t}</span>`).join(''); }
  function tip(t){ const m=$('#msg'); m.textContent=t; setTimeout(()=>m.textContent='',1500); }
  async function upload(file,folder){
    const form=new FormData(); form.append('file',file); form.append('upload_preset',CLOUDINARY.unsignedPreset); if(folder) form.append('folder',folder);
    const r=await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY.cloudName}/upload`,{method:'POST',body:form});
    const d=await r.json(); if(!r.ok||!d.secure_url) throw new Error(d.error?.message||'上传失败'); return d.secure_url;
  }
  </script>
</body>
</html>
